---
title: Shellè„šæœ¬ä¸­å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½
lang: zh-CN
date: 2024-05-14 00:00:41
author: makaspacex
cover: 
tags:
---


# Shellè„šæœ¬ä¸­å®ç°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½
åŸæ–‡ï¼šhttps://developer.aliyun.com/article/395993


# æ¦‚è¿°

è™½ç„¶CLIï¼ˆå‘½ä»¤è¡Œï¼‰ç±»å‹çš„å·¥å…·ç”±äºå…¶é«˜æ•ˆï¼Œæ˜“å®šåˆ¶çš„ç‰¹æ€§ä¸ºå¾ˆå¤šäººæ‰€å–œçˆ±ï¼ˆä¹ŸåŒ…æ‹¬æˆ‘è‡ªå·±ï¼‰ï¼Œ ä½†æ˜¯ï¼Œç›¸å¯¹äºGUIå·¥å…·ï¼ŒCLIå·¥å…·ç»™äººçš„ç›´è§‚æ„Ÿè§‰å°±æ˜¯ä¸å®¹æ˜“ä½¿ç”¨ï¼Œå¦‚æœçœ‹åˆ°å·¥å…·ä¸­å¤§é‡çš„å‚æ•°è¯´æ˜åï¼Œæ›´è®©äººæœ›è€Œå´æ­¥ã€‚

å› æ­¤ï¼Œå¦‚æœåœ¨è‡ªå·±å‘½ä»¤è¡Œå·¥å…·ä¸­åŠ å…¥ **è‡ªåŠ¨è¡¥å…¨** çš„åŠŸèƒ½ï¼Œå°±å¯ä»¥æå¤§çš„æé«˜å·¥å…·çš„æ˜“ç”¨æ€§ï¼Œè¿˜å¯ä»¥ä¿ç•™å‘½ä»¤è¡Œå·¥å…·åŸæœ‰çš„é«˜æ•ˆã€‚ è¿™é‡Œæ‰€è¯´çš„ **è‡ªåŠ¨è¡¥å…¨** ä¸ä»…ä»…æ˜¯è¡¥å…¨é‚£äº›å›ºå®šçš„å‚æ•°ï¼ˆè¿™äº›æ„ä¹‰ä¸å¤§ï¼‰ï¼Œæ›´å¤šçš„æ˜¯è¡¥å…¨åŠ¨æ€çš„å†…å®¹ã€‚

æœ¬ç¯‡ä¸»è¦ä»‹ç»ä¸¤ç§ä¸»æµçš„ shellï¼ˆbash å’Œ zshï¼‰ä¸­ï¼Œå¦‚ä½•å®ç°å‘½ä»¤è¡Œå·¥å…·çš„è¡¥å…¨ã€‚

# bash è‡ªåŠ¨è¡¥å…¨

## æµ‹è¯•è¡¥å…¨çš„è„šæœ¬

ç®€å•ç¼–å†™ä¸€ä¸ªæµ‹è¯•è„šæœ¬ç”¨æ¥æµ‹è¯•åé¢çš„è‡ªåŠ¨è¡¥å…¨ï¼š

```bash
#!/bin/bash
# filename: cli-test.sh

UPCASE=false
DATE=""

usage() {
    echo "USAGE:"
    echo "cli-test <options>"
    echo "    -h      : print help"
    echo "    -u      : print info upcase"
    echo "    -p <xxx>: print info"
    echo "    -d <xxx>: date in print info"
}

print() {
    if $UPCASE
    then
       echo -n $1 | tr a-z A-Z
    else
        echo -n $1
    fi

    if [ "$DATE" != "" ]
    then
        echo "   date: $DATE"
    else
        echo ""
    fi
}

while getopts "hup:d:" opt; do
    case "$opt" in
        h)
            usage
            exit 0
            ;;
        u)
            UPCASE=true
            ;;
        d)
            DATE=$OPTARG
            ;;
        p)
            print $OPTARG
            ;;
    esac
done
```

æµ‹è¯•ä¸Šé¢çš„è„šæœ¬å¦‚ä¸‹ï¼š

```shell
bash-3.2$ chmod +x cli-test.sh
bash-3.2$ ./cli-test.sh -h
USAGE:
cli-test <options>
    -h      : print help
    -u      : print info upcase
    -p <xxx>: print info
    -d <xxx>: date in print info
bash-3.2$ ./cli-test.sh -p hello
hellobash-3.2$ ./cli-test.sh -p hello
hello
bash-3.2$ ./cli-test.sh -u -p hello
HELLO
bash-3.2$ ./cli-test.sh -u -d 2016-10-13 -p hello
HELLO   date: 2016-10-13
```

## å‚æ•°è‡ªåŠ¨è¡¥å…¨

å‚æ•°çš„è¡¥å…¨ä¸€èˆ¬æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·çš„å‚æ•°ä¸€èˆ¬éƒ½æ˜¯å›ºå®šçš„ã€‚ ä¸‹é¢çš„å‚æ•°è¡¥å…¨è„šæœ¬æ˜¯é’ˆå¯¹ ä¸Šé¢çš„ æµ‹è¯•è¡¥å…¨çš„è„šæœ¬ **cli-test.sh**

```bash
_complete_func() {
    local cur prev opts base
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    opts="-h -u -d -p"

    if [[ ${cur} == -* ]] ; then
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
        return 0
    fi

}

complete -F _complete_func cli-test.sh
```

è®©è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”Ÿæ•ˆçš„æ–¹æ³•å¦‚ä¸‹ï¼š

```shell
bash-3.2$ source bash_complete          # ä½¿è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”Ÿæ•ˆ
bash-3.2$ ./cli-test.sh -<TAB><TAB>     # è¿™é‡Œè¾“å…¥ - ä¹‹åï¼Œå†è¾“å…¥2æ¬¡<TAB>å°±å¯ä»¥æŠŠæ‰€æœ‰èƒ½è¡¥å…¨çš„å‚æ•°åˆ—å‡ºæ¥
```

## è‡ªå®šä¹‰è¡¥å…¨

ä¸Šé¢çš„è¡¥å…¨æ˜¯è¡¥å…¨å›ºå®šçš„å‚æ•°ï¼Œç®€å•ï¼Œä½†æ˜¯ç”¨å¤„ä¹Ÿä¸å¤§ï¼Œç”¨æˆ·è®°ä¸ä½çš„å…¶å®å°±æ˜¯é‚£äº›ä¼šå˜çš„å‚æ•°å†…å®¹ã€‚ ä¸‹é¢å°è¯•åŠ¨æ€è¡¥å…¨ **cli-test.sh** çš„å‚æ•° -d çš„å†…å®¹ï¼ˆå†…å®¹æ˜¯å½“å‰æ—¥æœŸä»¥åŠå‰3å¤©å’Œåä¸‰å¤©çš„æ—¥æœŸï¼‰ ä¿®æ”¹ bash_complete è„šæœ¬å¦‚ä¸‹ï¼š

```bash
_complete_func() {
    local cur prev opts base
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    if [[ ${cur} == -* ]] ; then
        opts="-h -u -d -p"
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
    else
        opts=$( _complete_d_option )
        COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
    fi

    return 0
}

_complete_d_option() {
    date -v -3d +"%Y-%m-%d"
    date -v -2d +"%Y-%m-%d"
    date -v -1d +"%Y-%m-%d"
    date +"%Y-%m-%d"
    date -v +1d +"%Y-%m-%d"
    date -v +2d +"%Y-%m-%d"
    date -v +3d +"%Y-%m-%d"
}

complete -F _complete_func cli-test.sh
```

æµ‹è¯•åŠ¨æ€è¡¥å…¨çš„æ•ˆæœ

```shell
bash-3.2$ source bash_complete          # ä½¿è‡ªåŠ¨è¡¥å…¨è„šæœ¬ç”Ÿæ•ˆ
bash-3.2$ ./cli-test.sh -u -d 2016-10-1<TAB><TAB>   # è¿™æ˜¯ 2016-10-13 æ‰§è¡Œçš„ç»“æœï¼Œå…¶ä»–æ—¥å­çš„ç»“æœä¼šä¸ä¸€æ ·
2016-10-10  2016-10-11  2016-10-12  2016-10-13  2016-10-14  2016-10-15  2016-10-16
```

ä¸Šé¢å°±æ˜¯åŠ¨æ€è¡¥å…¨ï¼Œ_complete_d_option å‡½æ•°å°±æ˜¯ç”¨æ¥å®ç°åŠ¨æ€è¡¥å…¨çš„ã€‚

# zsh è‡ªåŠ¨è¡¥å…¨

ç›¸æ¯”äºbashï¼Œzsh çš„è¡¥å…¨æœºåˆ¶æ›´åŠ å¼ºå¤§ï¼Œä¹Ÿæ›´åŠ ç›´è§‚ã€‚ åŒæ ·ï¼Œä¸‹é¢ä¹Ÿé€šè¿‡ä¾‹å­æ¥æ¼”ç¤ºå¦‚ä½•åœ¨ zsh ä¸­å®ç°ä¸Šé¢ bash ä¸­åŒæ ·çš„è¡¥å…¨åŠŸèƒ½ã€‚

## å‚æ•°è‡ªåŠ¨è¡¥å…¨

ç›¸æ¯”äº bash çš„è‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼Œæˆ‘è§‰å¾— zsh çš„è¡¥å…¨æ–¹å¼æ›´åŠ ç›´è§‚ã€‚

```bash
#compdef cli-test.sh
# filename: _cli-test.h

_cli_test() {

    _arguments -C -s -S \
               '-h::' \
               '-u::' \
               '-d::' \
               '-p::'
}

_cli_test "$@"
```

zsh ä¸­æœ‰ä¸ª fpath çš„å†…ç½®å˜é‡ï¼Œå°†è‡ªåŠ¨è¡¥å…¨è„šæœ¬æ”¾åœ¨ fpathä¸­ï¼Œæˆ–è€…åœ¨ğ‘“ğ‘ğ‘ğ‘¡â„ä¸­ï¼Œæˆ–è€…åœ¨fpath ä¸­åˆ›å»ºæŒ‡å‘è‡ªåŠ¨è¡¥å…¨çš„è„šæœ¬çš„è½¯è¿æ¥éƒ½å¯ä»¥ã€‚ ä¸‹é¢æ˜¯æˆ‘çš„ç¯å¢ƒä¸­ fpath çš„å€¼

```shell
$ echo $fpath
/usr/local/share/zsh/site-functions /usr/share/zsh/site-functions /usr/share/zsh/5.0.8/functions
```

ä¸ºäº†æµ‹è¯• zsh ä¸‹è‡ªåŠ¨è¡¥å…¨æ˜¯å¦æœ‰æ•ˆï¼Œæˆ‘åœ¨ fpath ä¸‹ç»™è‡ªå·±çš„è‡ªåŠ¨è¡¥å…¨è„šæœ¬åˆ›å»ºäº†è½¯è¿æ¥

```shell
$ cd /usr/local/share/zsh/site-functions
$ ln -s ~/projects/bash/autocomp/_cli-test.sh _cli-test.sh
```

æµ‹è¯•ç»“æœ

```shell
$ ./cli-test.sh -<TAB><TAB>
-d  -h  -p  -u
```

å¯ä»¥çœ‹å‡ºï¼Œzsh çš„è¡¥å…¨æ–¹æ³•éå¸¸ç®€å•ç›´è§‚ã€‚ç¨å¾®è§£é‡Šä¸‹ä¸Šé¢çš„ä»£ç 

```shell
_arguments
```

è¿™ä¸ªå‡½æ•°æ˜¯ zsh è‡ªå¸¦çš„ï¼Œæœ‰ç‚¹ç±»ä¼¼ bash ä¸­çš„ compgen ï¼Œä½†æ˜¯åŠŸèƒ½æ›´åŠ å¼ºå¤§ã€‚

```shell
'-h::' \
```

è¿™é‡Œ **:** åˆ†å‰²çš„3éƒ¨åˆ†åˆ†åˆ«æ˜¯ â€œå¾…è¡¥å…¨çš„å‚æ•°:å‚æ•°çš„è¯´æ˜:åŠ¨æ€è¡¥å…¨å‚æ•°çš„å†…å®¹â€œ

## è‡ªå®šä¹‰è¡¥å…¨

æ ¹æ®ä¸Šé¢çš„è§£é‡Šï¼Œè¦æƒ³åŠ¨æ€è¡¥å…¨ -d å‚æ•°éå¸¸ç®€å•ï¼Œåªè¦åŠ ä¸ªå‡½æ•°ï¼Œå¹¶é…ç½®åœ¨ -d:: ä¹‹åå³å¯

```bash
#compdef cli-test.sh
# filename: _cli-test.h

_cli_test() {

    _arguments -C -s -S \
               '-h::' \
               '-u::' \
               '-d:auto complete date:__complete_d_option' \
               '-p::'
}

__complete_d_option() {
    local expl
    dates=( `generate_date` )

    _wanted dates expl date compadd $* - $dates
}

generate_date() {
    date -v -3d +"%Y-%m-%d"
    date -v -2d +"%Y-%m-%d"
    date -v -1d +"%Y-%m-%d"
    date +"%Y-%m-%d"
    date -v +1d +"%Y-%m-%d"
    date -v +2d +"%Y-%m-%d"
    date -v +3d +"%Y-%m-%d"
}

_cli_test "$@"
```

æµ‹è¯•åŠ¨æ€è¡¥å…¨çš„æ•ˆæœ

```shell
$ ./cli-test.sh -u -d 2016-10-<TAB><TAB>
2016-10-14  2016-10-15  2016-10-16  2016-10-17  2016-10-18  2016-10-19  2016-10-20
```

# æ€»ç»“

2ä¸­shellç¯å¢ƒä¸‹çš„è‡ªåŠ¨è¡¥å…¨éƒ½ä»‹ç»å®Œäº†ï¼Œå®ƒä»¬è‡ªåŠ¨è¡¥å…¨çš„æœºåˆ¶éƒ½ä¸éš¾ï¼Œåªæ˜¯ zsh æ¯•ç«Ÿæ˜¯æ–°ä¸€ç‚¹çš„shellï¼Œè¡¥å…¨æ–¹å¼æ›´åŠ ç®€å•æ˜“æ‡‚ã€‚ ç‰¹åˆ«æ˜¯å¯¹äºå­˜åœ¨å­å‘½ä»¤å’Œå¤æ‚çš„å‚æ•°è¡¥å…¨ï¼Œä»¥åŠå‚æ•°å†…å®¹åŠ¨æ€è¡¥å…¨çš„æƒ…å†µä¸‹ï¼Œzsh çš„æœºåˆ¶æ›´åŠ æ˜“äºç»´æŠ¤ã€‚